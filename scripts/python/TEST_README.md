# I18n处理器测试套件

这是一套完整的测试系统，用于验证Dart代码国际化处理器的稳定性和正确性。

## 📁 测试文件结构

```
scripts/python/
├── test_i18n_processor.py    # 完整的单元测试套件
├── run_tests.py              # 快速测试运行器
├── batch_test.py             # 批量测试脚本
├── test_config.yaml          # 测试配置文件
└── TEST_README.md            # 本说明文件
```

## 🚀 快速开始

### 1. 运行快速测试

最简单的方式，验证基本功能：

```bash
cd scripts/python
python run_tests.py
```

这将运行4个核心测试：
- ✅ 基础单行替换
- ✅ 多行代码替换
- ✅ AI标记处理
- ✅ 错误处理

### 2. 运行完整单元测试

更全面的测试，包括边界情况：

```bash
python test_i18n_processor.py
```

### 3. 运行批量测试

使用项目中现有的YAML文件进行真实场景测试：

```bash
# 测试10个随机选择的文件
python batch_test.py

# 测试指定数量的文件
python batch_test.py --max-files 20

# 运行压力测试（5轮批量测试）
python batch_test.py --stress-test --iterations 5
```

## 📊 测试类型详解

### 基础功能测试

**测试内容：**
- 单行中文字符串替换
- 多行代码块替换
- AI处理标记的添加和处理
- 无效行号的错误处理
- 文件备份机制

**预期结果：**
- 所有基础功能正常工作
- 错误情况得到正确处理
- 文件完整性得到保证

### 批量测试

**测试内容：**
- 使用项目中真实的YAML文件
- 模拟AI响应进行代码替换
- 验证大量文件的处理稳定性

**成功标准：**
- 成功率 ≥ 80%：系统稳定
- 成功率 60-80%：部分问题
- 成功率 < 60%：需要修复

### 压力测试

**测试内容：**
- 多轮批量测试
- 验证系统在重复操作下的稳定性
- 检测内存泄漏和性能退化

## 🔧 测试配置

编辑 `test_config.yaml` 可以自定义测试行为：

```yaml
# 启用/禁用特定测试
basic_tests:
  enabled: true
  
# 批量测试设置
batch_tests:
  max_files: 10
  success_threshold: 80
  
# 压力测试设置
stress_tests:
  enabled: false
  iterations: 5
```

## 📈 测试结果解读

### 成功输出示例

```
🚀 开始运行I18n处理器快速稳定性测试
==================================================

🧪 测试1: 基础单行替换
✅ 基础替换测试通过

🧪 测试2: 多行代码替换
✅ 多行替换测试通过

🧪 测试3: AI标记处理
✅ AI标记处理测试通过

🧪 测试4: 错误处理
✅ 错误处理测试通过

==================================================
📊 测试结果: 4/4 通过
🎉 所有测试通过！Dart替换方法稳定性良好。
```

### 失败输出示例

```
🧪 测试1: 基础单行替换
❌ 替换内容不正确

📊 测试结果: 3/4 通过
⚠️  有 1 个测试失败，需要检查代码稳定性。
```

## 🐛 常见问题排查

### 1. 测试文件创建失败

**问题：** `PermissionError` 或文件创建失败

**解决：**
- 确保有足够的磁盘空间
- 检查临时目录权限
- 关闭可能占用文件的程序

### 2. YAML文件解析错误

**问题：** `yaml.YAMLError` 或解析失败

**解决：**
- 检查YAML文件格式是否正确
- 确保文件编码为UTF-8
- 验证必需字段是否存在

### 3. Dart文件不存在

**问题：** 批量测试中找不到Dart文件

**解决：**
- 确保项目结构完整
- 检查YAML文件中的路径是否正确
- 验证相对路径的基准目录

### 4. 行号超出范围

**问题：** `IndexError` 或行号验证失败

**解决：**
- 检查YAML文件中的行号是否正确
- 确保Dart文件没有被修改
- 验证start_line和end_line的合理性

## 🔍 调试技巧

### 1. 启用详细输出

```bash
# 在测试脚本中添加调试信息
python run_tests.py --verbose
```

### 2. 保留测试文件

修改测试脚本，注释掉清理代码：

```python
# finally:
#     shutil.rmtree(test_dir)  # 注释这行以保留测试文件
```

### 3. 单独测试特定功能

```python
# 只运行特定测试
if __name__ == '__main__':
    asyncio.run(test_basic_replacement())
```

## 📝 扩展测试

### 添加新的测试用例

1. 在 `run_tests.py` 中添加新的测试函数：

```python
async def test_new_feature():
    """测试新功能"""
    print("\n🧪 测试X: 新功能测试")
    # 测试逻辑
    return True
```

2. 将测试添加到测试列表：

```python
tests = [
    test_basic_replacement,
    test_multiline_replacement,
    test_ai_marker_handling,
    test_error_handling,
    test_new_feature,  # 新增
]
```

### 自定义测试数据

创建特定的测试YAML文件：

```yaml
# test_data/custom_test.yaml
path: test/custom.dart
start_line: 1
end_line: 1
code: "print('自定义测试');"
```

## 🎯 最佳实践

1. **定期运行测试**：在修改代码后运行快速测试
2. **批量测试验证**：在发布前运行批量测试
3. **压力测试检查**：定期运行压力测试确保稳定性
4. **监控成功率**：关注测试成功率的变化趋势
5. **及时修复问题**：测试失败时及时分析和修复

## 📞 支持

如果遇到问题或需要添加新的测试功能，请：

1. 检查本文档的常见问题部分
2. 查看测试输出的错误信息
3. 检查相关的日志文件
4. 考虑是否需要更新测试用例

---

**注意：** 这套测试系统设计为非破坏性的，所有测试都在临时目录中进行，不会影响项目的实际文件。