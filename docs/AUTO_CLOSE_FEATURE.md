# 地图编辑器工具栏自动关闭功能

## 功能概述

为地图编辑器的三个工具栏面板（绘制工具、图层、图例管理）添加了自动关闭开关功能。当某个工具栏启用自动关闭时，点击其他工具栏会自动关闭该工具栏。

## 功能特性

### 1. 自动关闭开关
- 每个工具栏面板都有独立的自动关闭开关
- 开关位于工具栏标题栏的右侧
- 默认情况下，所有工具栏的自动关闭功能都是启用的

### 2. 智能关闭逻辑
- 当点击某个工具栏时，所有启用了自动关闭功能的其他工具栏会自动关闭
- 只有启用了自动关闭的工具栏才会被自动关闭
- 禁用自动关闭的工具栏不会受到影响

### 3. 用户界面
- **展开状态**：开关显示在标题栏右侧，带有"自动关闭"文字标签
- **折叠状态**：开关显示在折叠标题栏右侧，无文字标签
- **提示信息**：鼠标悬停在开关上时显示详细说明

### 4. 图层状态显示 🆕
- **图层面板折叠状态**：在标题下方显示当前选中的图层名称
- **格式**：`当前: [图层名称]` 或 `未选择图层`
- **样式**：使用较小字体和浅色显示，避免干扰主要内容
- **响应式**：文本过长时自动省略，保持界面整洁

## 使用方法

### 启用/禁用自动关闭
1. 找到目标工具栏面板的标题栏
2. 点击右侧的自动关闭开关
3. 开关打开 = 启用自动关闭
4. 开关关闭 = 禁用自动关闭

### 查看当前图层信息 🆕
1. 将图层面板折叠（点击标题栏）
2. 在图层标题下方查看当前选中的图层名称
3. 格式显示为：`当前: [图层名称]`
4. 如果没有选中图层，显示：`未选择图层`

### 工作原理
1. **场景一**：绘制工具栏和图层面板都启用自动关闭
   - 当前绘制工具栏展开，图层面板折叠
   - 点击图层面板标题 → 图层面板展开，绘制工具栏自动关闭

2. **场景二**：绘制工具栏启用自动关闭，图层面板禁用自动关闭
   - 当前两个面板都展开
   - 点击图例管理面板 → 图例面板展开，绘制工具栏自动关闭，图层面板保持展开

## 技术实现

### 新增状态变量
```dart
// 自动关闭开关状态
bool _isDrawingToolbarAutoClose = true;
bool _isLayerPanelAutoClose = true;
bool _isLegendPanelAutoClose = true;
```

### 核心方法
- `_handlePanelToggle(String panelType)`: 处理面板切换和自动关闭逻辑
- `_buildCollapsiblePanel()`: 增加自动关闭开关参数和折叠副标题支持
- `_buildToolPanels()`: 更新面板构建逻辑，为图层面板添加动态副标题

### 界面组件
- 使用 `Switch` 组件实现开关
- 使用 `Tooltip` 提供悬停提示
- 使用 `Column` 布局在折叠状态下显示主标题和副标题
- 响应式设计，适配窄屏和宽屏

### 图层状态显示实现
```dart
collapsedSubtitle: _selectedLayer != null ? '当前: ${_selectedLayer!.name}' : '未选择图层',
```

## 兼容性

- 完全向后兼容现有功能
- 不影响预览模式的使用
- 支持宽屏和窄屏布局
- 保持原有的折叠/展开动画效果
- 图层状态显示不影响现有交互逻辑

## 最佳实践

1. **工作流优化**：根据使用习惯调整自动关闭设置
2. **多工具栏工作**：禁用常用工具栏的自动关闭功能
3. **单一焦点工作**：启用所有工具栏的自动关闭功能，保持界面简洁
4. **图层管理**：利用折叠状态的图层名称显示快速确认当前工作图层 🆕
