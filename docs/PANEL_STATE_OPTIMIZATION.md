# 面板状态保存优化

## 问题描述

在画布中使用折叠侧边栏、自动关闭等选项时会触发用户偏好设置的实时保存，导致使用过程中出现卡顿现象。

## 优化方案

将面板状态的保存机制从**实时保存**改为**退出时保存**，避免在使用过程中频繁触发用户偏好设置的保存操作。

## 技术实现

### 1. 新增状态跟踪变量

```dart
// 面板状态变更跟踪
bool _panelStatesChanged = false;
```

### 2. 修改面板切换逻辑

- `_handlePanelToggle()`: 面板折叠/展开时只标记状态变化，不立即保存
- `_handleAutoCloseToggle()`: 自动关闭开关切换时只标记状态变化，不立即保存

### 3. 退出时保存机制

```dart
/// 在退出时保存面板状态
Future<void> _savePanelStatesOnExit() async {
  if (!_panelStatesChanged || !mounted) {
    return;
  }

  // 只有当autoRestorePanelStates为true时才保存面板状态
  if (layout.autoRestorePanelStates) {
    await prefsProvider.updateLayout(
      panelCollapsedStates: {...},
      panelAutoCloseStates: {...},
    );
  }
}
```

### 4. 多种退出方式支持

- **正常退出**: 在`_showExitConfirmDialog()`开始时保存面板状态
- **不保存退出**: 仍然保存面板状态（因为面板状态与地图数据无关）
- **保存并退出**: 保存地图数据后再保存面板状态
- **页面销毁**: 在`dispose()`方法中异步保存面板状态

## 用户设置控制

用户可以在**设置 → 界面布局设置**中控制此功能：

- **保存面板状态变更**: 退出地图编辑器时自动保存面板折叠/展开状态
- 设置项: `layout.autoRestorePanelStates`
- 默认值: `true`

## 优化效果

### 优化前
- ❌ 每次折叠/展开面板都会触发用户偏好设置保存
- ❌ 切换自动关闭开关时立即保存设置
- ❌ 频繁的I/O操作导致界面卡顿

### 优化后
- ✅ 使用过程中不进行任何保存操作
- ✅ 只在退出时统一保存面板状态
- ✅ 大幅减少I/O操作，界面流畅度显著提升
- ✅ 保持用户体验一致性，面板状态仍然会被记住

## 兼容性

- 完全向后兼容现有功能
- 用户可以通过设置控制是否保存面板状态
- 不影响其他用户偏好设置的保存机制
- 支持多种退出方式的状态保存

## 技术细节

1. **状态标记**: 使用`_panelStatesChanged`标记面板状态是否有变化
2. **延迟保存**: 只在确实需要退出时才进行保存操作
3. **异步处理**: 在`dispose()`中使用异步保存但不阻塞页面销毁
4. **错误处理**: 保存失败时记录日志但不影响用户操作
5. **设置控制**: 通过`autoRestorePanelStates`设置控制是否保存

## 最佳实践

1. **性能优先**: 优先考虑使用过程中的流畅性
2. **数据一致性**: 确保在各种退出方式下都能保存状态
3. **用户控制**: 给用户选择是否保存面板状态的权利
4. **优雅降级**: 即使保存失败也不影响用户的正常使用
