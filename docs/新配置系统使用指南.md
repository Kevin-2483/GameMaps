# 新配置系统使用指南

## 概述

新的配置系统支持基于平台的功能和页面管理，使用数组而不是布尔值来管理启用状态。

## 配置文件结构

`assets/config/app_config.json` 现在使用以下结构：

```json
{
  "platform": {
    "Windows": {
      "pages": ["HomePage", "SettingsPage"],
      "features": ["DarkTheme", "MultiLanguage", "DebugMode"]
    },
    "MacOS": {
      "pages": ["HomePage", "SettingsPage"], 
      "features": ["DarkTheme", "MultiLanguage"]
    },
    "Android": {
      "pages": ["HomePage"],
      "features": ["DarkTheme"]
    }
  },
  "build": {
    "appName": "R6Box",
    "version": "1.0.0",
    "buildNumber": "1",
    "enableLogging": true
  }
}
```

## 模块 ID 系统

### 页面模块

页面模块现在需要定义一个 `moduleId` 常量：

```dart
class HomePageModule extends PageModule {
  static const String moduleId = 'HomePage';
  
  @override
  bool get isEnabled {
    // 编译时检查
    if (!BuildTimeConfig.isPageEnabled(moduleId)) {
      return false;
    }
    
    // 运行时检查
    return ConfigManager.instance.isCurrentPlatformPageEnabled(moduleId);
  }
}
```

### 功能模块

功能模块同样需要定义 `featureId`：

```dart
class SystemInfoFeature implements FeatureModule {
  static const String featureId = 'DebugMode';
  
  @override
  bool get isEnabled {
    return ConfigManager.instance.isCurrentPlatformFeatureEnabled(featureId);
  }
}
```

## 构建流程

### 1. 生成构建配置

```bash
# Windows
dart scripts/build_config_generator.dart Windows

# Android
dart scripts/build_config_generator.dart Android

# Web
dart scripts/build_config_generator.dart Web
```

### 2. 使用构建脚本

```bash
# Windows
scripts/build.ps1 Windows release

# Linux/macOS
./scripts/build.sh Android debug
```

## API 参考

### BuildTimeConfig

- `BuildTimeConfig.isPageEnabled(String pageId)` - 检查页面是否在编译时启用
- `BuildTimeConfig.isFeatureEnabled(String featureId)` - 检查功能是否在编译时启用
- `BuildTimeConfig.enabledPages` - 获取启用的页面列表
- `BuildTimeConfig.enabledFeatures` - 获取启用的功能列表

### ConfigManager

- `ConfigManager.instance.isCurrentPlatformPageEnabled(String pageId)` - 检查当前平台是否启用页面
- `ConfigManager.instance.isCurrentPlatformFeatureEnabled(String featureId)` - 检查当前平台是否启用功能
- `ConfigManager.instance.getCurrentPlatform()` - 获取当前平台名称
- `ConfigManager.instance.isPlatformConfigured(String platform)` - 检查平台是否配置

## 可用的 ID

### 页面 ID
- `HomePage` - 主页
- `SettingsPage` - 设置页
- `TrayNavigation` - 托盘导航

### 功能 ID
- `DarkTheme` - 深色主题
- `MultiLanguage` - 多语言支持
- `DebugMode` - 调试模式
- `ExperimentalFeatures` - 实验性功能

## 迁移指南

如果你有使用旧配置系统的代码，需要进行以下更改：

### 旧方式
```dart
if (!BuildTimeConfig.enableHomePage) {
  return false;
}
return config.pages.enableHomePage;
```

### 新方式
```dart
if (!BuildTimeConfig.isPageEnabled('HomePage')) {
  return false;
}
return ConfigManager.instance.isCurrentPlatformPageEnabled('HomePage');
```

## 最佳实践

1. **为每个模块定义常量 ID**：避免魔法字符串，使用 `static const String moduleId = 'HomePage'`
2. **同时检查编译时和运行时配置**：确保功能在两个级别都被正确启用
3. **使用描述性的 ID 名称**：如 `HomePage` 而不是 `home`
4. **平台特定配置**：根据不同平台的需求配置不同的功能集

## 故障排除

### 常见问题

1. **构建时找不到功能**：确保在 `app_config.json` 中为目标平台配置了相应的功能
2. **运行时功能不可用**：检查 `ConfigManager` 是否正确加载了配置文件
3. **编译错误**：确保运行了 `flutter packages pub run build_runner build` 重新生成序列化代码

### 调试技巧

使用 `BuildTimeConfig.buildInfo` 查看当前构建配置：

```dart
print(BuildTimeConfig.buildInfo);
```

这将输出当前启用的页面和功能列表。
