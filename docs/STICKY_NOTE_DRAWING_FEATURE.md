# 便签绘制功能优化

## 功能概述

现在当选中便签时，绘制工具将被启用，用户可以在便签的内容区域内进行绘制，但被限制不能绘制到其他区域。

## 实现的功能

### 1. 绘制工具状态管理

- **启用条件**: 选中图层 OR 选中便签时，绘制工具都会启用
- **禁用条件**: 没有选中任何图层或便签时，绘制工具禁用

### 2. 绘制区域限制

- **便签绘制**: 当选中便签时，只能在便签的内容区域（排除标题栏和边距）内绘制
- **图层绘制**: 当选中图层时，可以在整个画布区域绘制
- **区域检测**: 点击便签内容区域外时，绘制操作被阻止

### 3. 用户界面提示

- **工具栏状态**: 绘制工具栏副标题显示当前绘制目标（"绘制到便签: [便签标题]" 或 "绘制到: [图层名称]"）
- **视觉提示**: 选中便签时，内容区域显示淡色边框，提示可绘制区域
- **空便签提示**: 当便签为空且被选中时，显示"可在此区域绘制"的提示图标和文字

### 4. 禁用蒙板更新

- 禁用状态提示从"请先选择一个图层或图层组"更新为"请先选择一个图层、图层组或便签"

## 修改的文件

### 1. `map_editor_page.dart`

- **_shouldDisableDrawingTools**: 修改绘制工具禁用逻辑，选中便签时也启用绘制工具
- **collapsedSubtitle**: 更新工具栏副标题显示逻辑，显示当前绘制目标
- **_hasNoLayerSelected**: 更新逻辑，包含便签选择状态
- **禁用蒙板文字**: 更新提示文字

### 2. `map_canvas.dart`

- **_onDrawingStart**: 修改绘制开始逻辑，当选中便签时检查绘制位置是否在内容区域内
  - 如果在内容区域内：启动便签绘制
  - 如果在内容区域外：阻止绘制
  - 如果选中图层：正常图层绘制

### 3. `sticky_note_display.dart`

- **_buildContentArea**: 为选中的便签添加视觉提示
  - 添加淡色边框指示可绘制区域
  - 当便签为空时显示绘制提示图标和文字

## 技术细节

### 绘制区域计算

```dart
// 计算便签内容区域边界（排除标题栏和padding）
const double titleBarHeight = 36.0; // 标题栏固定高度
const double contentPadding = 10.0; // 内容区域的 padding

final contentAreaRect = Rect.fromLTWH(
  stickyNotePosition.dx + contentPadding,
  stickyNotePosition.dy + titleBarHeight + contentPadding,
  stickyNoteSize.width - (contentPadding * 2),
  stickyNoteSize.height - titleBarHeight - (contentPadding * 2),
);
```

### 绘制逻辑流程

1. **绘制开始**: 检查当前选中状态
   - 选中便签 → 检查点击位置是否在便签内容区域
   - 选中图层 → 正常图层绘制
   - 都未选中 → 阻止绘制

2. **绘制更新**: 根据当前绘制状态继续
   - 便签绘制 → 调用便签绘制更新方法
   - 图层绘制 → 调用图层绘制更新方法

3. **绘制结束**: 根据当前绘制状态完成
   - 便签绘制 → 将绘制元素添加到便签
   - 图层绘制 → 将绘制元素添加到图层

## 使用体验

1. **选中便签**: 绘制工具启用，工具栏显示"绘制到便签: [便签名]"
2. **点击便签内容区域**: 开始绘制，绘制内容保存到便签
3. **点击便签外区域**: 绘制被阻止，不会产生任何绘制内容
4. **空便签选中**: 显示绘制提示，引导用户在正确区域绘制
5. **便签与图层切换**: 可以在便签绘制和图层绘制之间无缝切换

这样的设计确保了绘制功能的直观性和一致性，用户可以清楚地知道当前的绘制目标和可绘制区域。
