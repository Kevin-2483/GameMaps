# 图例组管理器新功能说明

## 功能概述

为图例组管理窗口新增了两个可折叠栏目，用于更好地管理和使用VFS图例缓存系统。

## 新增功能

### 1. VFS图例目录树 📁

**位置**: 图例组管理窗口中的可折叠区域

**功能特点**:
- 以树形结构展示VFS图例存储服务的目录结构
- 不包括图例文件本身，只显示目录
- 每个目录节点前有复选框，支持多选
- 可展开/收起子目录
- 支持多层嵌套目录结构

**使用方法**:
1. 点击"VFS图例目录"标题展开/收起整个区域
2. 点击目录节点前的箭头展开/收起子目录
3. 勾选目录节点的复选框来选择该目录
4. 选中目录后，该目录下的所有图例将自动加载到缓存系统
5. 取消选中时，会清理该目录下的图例缓存（但保留正在使用的图例）

### 2. 缓存图例展示 🎯

**位置**: 图例组管理窗口中的可折叠区域

**功能特点**:
- 显示当前图例缓存系统中已加载的图例项
- 使用小正方形图标多行多列展示（每行4个）
- 按目录节点分类展示，便于快速查找
- 支持点击图标快速使用图例
- 显示图例预览和名称

**使用方法**:
1. 点击"缓存图例"标题展开/收起整个区域
2. 按目录分组查看已缓存的图例
3. 点击图例图标可快速选择并使用该图例
4. 通过目录分组快速定位需要的图例

### 3. 可折叠区域设计 📋

**新的UI布局**:
- **设置选项**: 原有的图例组设置（可见性、透明度、智能隐藏、标签等）
- **VFS图例目录**: 新增的目录树选择器
- **缓存图例**: 新增的缓存图例展示
- **图例列表**: 原有的图例项列表

所有区域都支持折叠/展开，为用户提供更灵活的工作空间。

## 技术实现

### 核心组件

1. **VfsDirectoryTreeManager** (`vfs_directory_tree.dart`)
   - 管理VFS目录树结构
   - 处理节点选中/取消选中
   - 与缓存管理器集成

2. **VfsDirectoryTreeDisplay** (`vfs_directory_tree_display.dart`)
   - 显示VFS目录树UI
   - 处理用户交互（展开、选中等）

3. **CachedLegendsDisplay** (`cached_legends_display.dart`)
   - 显示缓存图例网格
   - 按目录分组展示
   - 处理图例选择

4. **LegendCacheManager** (增强)
   - 新增获取所有缓存图例的方法
   - 支持按目录清理缓存

### 缓存机制

- **预加载**: 选中目录时，自动预加载该目录下的所有图例
- **智能清理**: 取消选中时，只清理未被当前地图使用的图例
- **状态同步**: 缓存状态与UI同步更新

## 使用场景

### 典型工作流程

1. **浏览目录**: 在VFS目录树中浏览可用的图例目录
2. **批量加载**: 选中感兴趣的目录，批量加载图例到缓存
3. **快速使用**: 在缓存图例展示中快速找到并使用图例
4. **管理缓存**: 根据需要取消选中目录来清理不需要的缓存

### 性能优化

- **按需加载**: 只有选中的目录才会加载图例
- **缓存复用**: 避免重复加载相同的图例
- **内存管理**: 自动清理未使用的图例缓存

## 调试信息

在开发模式下，VFS目录树构建过程会输出详细的调试信息：
- 文件夹处理过程
- 节点创建情况
- 树结构层次

这些信息帮助诊断目录结构问题，特别是像 `indexeddb://r6box/legends/2` 这样的路径解析。

## 注意事项

1. **目录选择**: 目录树只显示文件夹，不显示图例文件
2. **缓存管理**: 系统会自动管理缓存，但用户也可以手动控制
3. **性能考虑**: 大量图例可能影响加载性能，建议按需选择目录
4. **数据一致性**: 缓存与VFS数据保持同步

## 后续改进

- [ ] 添加搜索功能
- [ ] 支持拖拽操作
- [ ] 优化大量图例的加载性能
- [ ] 添加图例使用统计
- [ ] 支持自定义缓存策略
